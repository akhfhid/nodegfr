<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Autofill</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.07);
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --bg-input: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.08);
            --input-border: rgba(255, 255, 255, 0.1);
            --shadow-soft: rgba(0, 0, 0, 0.2);
            --header-bg: rgba(5, 5, 5, 0.8);
            --header-border: rgba(255, 255, 255, 0.05);
            --primary: #8b5cf6;
            --secondary: #06b6d4;
            --accent-glow: rgba(139, 92, 246, 0.5);
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --border-radius: 20px;
            --max-width: 1200px;
            --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body.light-theme {
            --bg-deep: #FAFAFA;
            --bg-card: rgba(255, 255, 255, 0.6);
            --bg-card-hover: rgba(255, 255, 255, 0.85);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --bg-input: rgba(0, 0, 0, 0.03);
            --border-color: rgba(0, 0, 0, 0.05);
            --input-border: rgba(0, 0, 0, 0.08);
            --shadow-soft: rgba(0, 0, 0, 0.05);
            --header-bg: rgba(255, 255, 255, 0.8);
            --header-border: rgba(0, 0, 0, 0.05);
            --primary: #7c3aed;
            --secondary: #0891b2;
            --accent-glow: rgba(124, 58, 237, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            overflow: hidden;
            background: var(--bg-deep);
            transition: background 0.5s ease;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(30px);
            opacity: 0.35;
            animation: floatOrb 20s infinite ease-in-out;
            will-change: transform;
            transform: translateZ(0);
            transition: background 0.5s ease, opacity 0.5s ease;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: var(--primary);
            top: -100px;
            left: -100px;
        }

        .orb-2 {
            width: 500px;
            height: 500px;
            background: var(--secondary);
            bottom: -150px;
            right: -150px;
            animation-delay: -5s;
            animation-direction: alternate-reverse;
        }

        .orb-3 {
            width: 300px;
            height: 300px;
            background: #d946ef;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) translateZ(0);
            opacity: 0.2;
            animation: pulseOrb 15s infinite ease-in-out;
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        @keyframes floatOrb {
            0% {
                transform: translate(0, 0) scale(1);
            }

            50% {
                transform: translate(30px, 50px) scale(1.1);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes pulseOrb {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.3;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.5;
            }
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px 40px;
            position: relative;
            z-index: 1;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            background: var(--header-bg);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border-bottom: 1px solid var(--header-border);
            margin-bottom: 30px;
        }

        .header-inner {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: -1px;
            color: var(--text-main);
            text-decoration: none;
            transition: var(--transition);
        }

        .logo i {
            color: var(--secondary);
            filter: drop-shadow(0 0 8px rgba(6, 182, 212, 0.4));
        }

        .logo span {
            background: linear-gradient(to right, var(--text-main), #6366f1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        nav {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: var(--transition);
            position: relative;
        }

        nav a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 0;
            background: var(--secondary);
            transition: width 0.3s;
        }

        nav a:hover {
            color: var(--text-main);
        }

        nav a:hover::after {
            width: 100%;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 15px 5px 5px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Theme Toggle */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: .4s;
            border-radius: 34px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background-color: var(--primary);
            transition: .4s;
            border-radius: 50%;
            z-index: 2;
        }

        input:checked+.slider {
            background-color: var(--bg-input);
        }

        input:checked+.slider:before {
            transform: translateX(30px);
        }

        .icon-dark,
        .icon-light {
            color: var(--text-muted);
            font-size: 14px;
            z-index: 1;
        }

        .icon-light {
            color: #f59e0b;
        }

        /* Glass Panel */
        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 24px var(--shadow-soft);
            transition: var(--transition);
            padding: 24px;
            margin-bottom: 24px;
        }

        .glass-panel:hover {
            background: var(--bg-card-hover);
            transform: translateY(-2px);
        }

        /* Page Title */
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(to right, var(--text-main), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 30px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 24px;
            text-align: center;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.3rem;
        }

        .stat-icon.users {
            background: rgba(139, 92, 246, 0.2);
            color: var(--primary);
        }

        .stat-icon.purchased {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
        }

        .stat-icon.used {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .stat-icon.forms {
            background: rgba(6, 182, 212, 0.2);
            color: var(--secondary);
        }

        .stat-icon.vouchers {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-main);
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            background: var(--bg-input);
        }

        .data-table td {
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .data-table tr:hover td {
            background: var(--bg-input);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-cell img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-cell .name {
            font-weight: 600;
        }

        .user-cell .email {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--accent-glow);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.75rem;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-input);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-icon.danger:hover {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
        }

        /* Form Inputs */
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 150px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--input-border);
            background: var(--bg-input);
            color: var(--text-main);
            font-family: inherit;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.2);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            border-radius: 10px;
            background: transparent;
            color: var(--text-muted);
            border: none;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn:hover {
            color: var(--text-main);
            background: var(--bg-input);
        }

        .tab-btn.active {
            color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Search */
        .search-box {
            position: relative;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 50px;
            border: 1px solid var(--input-border);
            background: var(--bg-input);
            color: var(--text-main);
            font-family: inherit;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading .fa-spinner {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-inner {
                flex-wrap: wrap;
                gap: 15px;
            }

            nav {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }

            .form-row {
                flex-direction: column;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-deep);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* SweetAlert2 Custom Styling - Glassmorphism */
        .swal2-popup {
            background: var(--bg-card) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--border-radius) !important;
            color: var(--text-main) !important;
            box-shadow: 0 8px 32px var(--shadow-soft) !important;
            will-change: transform, opacity;
        }

        .swal2-container {
            backdrop-filter: none !important;
            background: rgba(0, 0, 0, 0.5) !important;
        }

        .swal2-title {
            color: var(--text-main) !important;
            font-family: 'Space Grotesk', sans-serif !important;
            font-weight: 700 !important;
        }

        .swal2-html-container {
            color: var(--text-main) !important;
        }

        .swal2-input {
            background: var(--bg-input) !important;
            border: 1px solid var(--input-border) !important;
            border-radius: 10px !important;
            color: var(--text-main) !important;
            font-family: 'Space Grotesk', sans-serif !important;
        }

        .swal2-input:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.2) !important;
        }

        .swal2-input::placeholder {
            color: var(--text-muted) !important;
        }

        .swal2-validation-message {
            background: rgba(239, 68, 68, 0.1) !important;
            color: var(--accent-danger) !important;
            border-radius: 8px !important;
        }

        .swal2-confirm {
            font-family: 'Space Grotesk', sans-serif !important;
            font-weight: 600 !important;
            border-radius: 50px !important;
            padding: 10px 24px !important;
        }

        .swal2-cancel {
            font-family: 'Space Grotesk', sans-serif !important;
            font-weight: 600 !important;
            border-radius: 50px !important;
            padding: 10px 24px !important;
            background: var(--bg-input) !important;
            color: var(--text-main) !important;
            border: 1px solid var(--border-color) !important;
        }

        .swal2-cancel:hover {
            background: var(--bg-card-hover) !important;
        }

        /* Light theme adjustments for SweetAlert */
        body.light-theme .swal2-popup {
            background: rgba(255, 255, 255, 0.85) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
        }

        body.light-theme .swal2-input {
            background: rgba(0, 0, 0, 0.03) !important;
        }
    </style>
</head>

<body>
    <div class="ambient-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="noise-overlay"></div>
    </div>

    <header>
        <div class="header-inner">
            <a href="/" class="logo">
                <i class="fa-solid fa-bolt"></i>
                <span>Autofill</span>
            </a>

            <nav>
                <a href="/">Home</a>
                <a href="/admin" style="color: var(--primary);">Admin</a>
            </nav>

            <div style="display: flex; align-items: center; gap: 20px;">
                <label class="theme-switch">
                    <input type="checkbox" id="themeToggle">
                    <span class="slider">
                        <i class="fa-solid fa-moon icon-dark"></i>
                        <i class="fa-solid fa-sun icon-light"></i>
                    </span>
                </label>

                <% if (locals.user) { %>
                    <div class="user-menu">
                        <img src="/user/avatar?v=<%= user.id %>" alt="Avatar" class="user-avatar"
                            onerror="this.src='https://ui-avatars.com/api/?name=<%= user.name %>'">
                        <span class="user-name">
                            <%= user.name %>
                        </span>
                    </div>
                    <% } %>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title"><i class="fa-solid fa-shield-halved"></i> Admin Dashboard</h1>
        <p class="page-subtitle">Manage users, vouchers, and view platform statistics</p>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="glass-panel stat-card">
                <div class="stat-icon users"><i class="fa-solid fa-users"></i></div>
                <div class="stat-value" title="<%= stats.totalUsers %>">
                    <%= stats.totalUsers>= 1000000 ? (stats.totalUsers / 1000000).toFixed(1) + 'M' : stats.totalUsers >=
                        1000 ? (stats.totalUsers / 1000).toFixed(1) + 'k' : stats.totalUsers %>
                </div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="glass-panel stat-card">
                <div class="stat-icon purchased"><i class="fa-solid fa-coins"></i></div>
                <div class="stat-value" title="<%= stats.totalTokensPurchased %>">
                    <%= stats.totalTokensPurchased>= 1000000 ? (stats.totalTokensPurchased / 1000000).toFixed(1) + 'M' :
                        stats.totalTokensPurchased >= 1000 ? (stats.totalTokensPurchased / 1000).toFixed(1) + 'k' :
                        stats.totalTokensPurchased %>
                </div>
                <div class="stat-label">Tokens Purchased</div>
            </div>
            <div class="glass-panel stat-card">
                <div class="stat-icon used"><i class="fa-solid fa-fire"></i></div>
                <div class="stat-value" title="<%= stats.totalTokensUsed %>">
                    <%= stats.totalTokensUsed>= 1000000 ? (stats.totalTokensUsed / 1000000).toFixed(1) + 'M' :
                        stats.totalTokensUsed >= 1000 ? (stats.totalTokensUsed / 1000).toFixed(1) + 'k' :
                        stats.totalTokensUsed %>
                </div>
                <div class="stat-label">Tokens Used</div>
            </div>
            <div class="glass-panel stat-card">
                <div class="stat-icon forms"><i class="fa-solid fa-file-lines"></i></div>
                <div class="stat-value" title="<%= stats.totalFormsFilled %>">
                    <%= stats.totalFormsFilled>= 1000000 ? (stats.totalFormsFilled / 1000000).toFixed(1) + 'M' :
                        stats.totalFormsFilled >= 1000 ? (stats.totalFormsFilled / 1000).toFixed(1) + 'k' :
                        stats.totalFormsFilled %>
                </div>
                <div class="stat-label">Responses</div>
            </div>
            <div class="glass-panel stat-card">
                <div class="stat-icon vouchers"><i class="fa-solid fa-ticket"></i></div>
                <div class="stat-value">
                    <%= stats.activeVouchers %>
                </div>
                <div class="stat-label">Active Vouchers</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="users"><i class="fa-solid fa-users"></i> Users</button>
            <button class="tab-btn" data-tab="vouchers"><i class="fa-solid fa-ticket"></i> Vouchers</button>
            <button class="tab-btn" data-tab="transactions"><i class="fa-solid fa-receipt"></i> Transactions</button>
            <button class="tab-btn" data-tab="logs"><i class="fa-solid fa-clipboard-list"></i> Admin Logs</button>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content active">
            <div class="glass-panel">
                <div class="section-header">
                    <h2 class="section-title">All Users</h2>
                    <div class="search-box">
                        <i class="fa-solid fa-search"></i>
                        <input type="text" id="userSearch" placeholder="Search users...">
                    </div>
                </div>
                <div id="usersTable" class="loading">
                    <i class="fa-solid fa-spinner"></i>
                    <p>Loading users...</p>
                </div>
            </div>
        </div>

        <!-- Vouchers Tab -->
        <div id="vouchers" class="tab-content">
            <div class="glass-panel">
                <div class="section-header">
                    <h2 class="section-title">Create Voucher</h2>
                </div>
                <form id="createVoucherForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Voucher Code</label>
                            <input type="text" id="voucherCode" placeholder="e.g. DISCOUNT20" required>
                        </div>
                        <div class="form-group">
                            <label>Discount %</label>
                            <input type="number" id="voucherPercent" placeholder="e.g. 20" min="1" max="100" required>
                        </div>
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <input type="text" id="voucherDesc" placeholder="e.g. New Year Promo">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-plus"></i> Create Voucher
                    </button>
                </form>
            </div>

            <div class="glass-panel">
                <div class="section-header">
                    <h2 class="section-title">All Vouchers</h2>
                </div>
                <div id="vouchersTable" class="loading">
                    <i class="fa-solid fa-spinner"></i>
                    <p>Loading vouchers...</p>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="glass-panel">
                <div class="section-header">
                    <h2 class="section-title">Recent Transactions</h2>
                </div>
                <div id="transactionsTable" class="loading">
                    <i class="fa-solid fa-spinner"></i>
                    <p>Loading transactions...</p>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="glass-panel">
                <div class="section-header">
                    <h2 class="section-title">Admin Action Logs</h2>
                </div>
                <div id="logsTable" class="loading">
                    <i class="fa-solid fa-spinner"></i>
                    <p>Loading logs...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.checked = true;
        }
        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                document.body.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.remove('light-theme');
                localStorage.setItem('theme', 'dark');
            }
        });

        // Tab Switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Load Users
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();

                let html = `<table class="data-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Balance</th>
                            <th>Purchased</th>
                            <th>Used</th>
                            <th>Responses</th>
                            <th>Forms</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;

                users.forEach(u => {
                    html += `<tr>
                        <td>
                            <div class="user-cell">
                                <img src="${u.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.name)}" 
                                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}'">
                                <div>
                                    <div class="name">${u.name || 'Unknown'}</div>
                                    <div class="email">${u.email}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge badge-success">${u.tokenBalance}</span></td>
                        <td>${u.tokensPurchased}</td>
                        <td>${u.tokensUsed}</td>
                        <td>${u.responsesSubmitted}</td>
                        <td>
                            ${u.forms.length > 0 ?
                            `<button class="btn-icon" onclick="showUserForms('${u.name}', ${JSON.stringify(u.forms).replace(/"/g, '&quot;')})" title="Lihat ${u.forms.length} form">
                                    <i class="fa-solid fa-file-lines"></i> ${u.forms.length}
                                </button>` :
                            '<span style="color: var(--text-muted);">-</span>'
                        }
                        </td>
                        <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-icon" onclick="addTokenToUser('${u.id}', '${u.name}')" title="Add Tokens">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                            <button class="btn-icon danger" onclick="deleteTokenFromUser('${u.id}', '${u.name}', ${u.tokenBalance})" title="Delete Tokens">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                document.getElementById('usersTable').innerHTML = html;

                // Search
                document.getElementById('userSearch').addEventListener('input', (e) => {
                    const q = e.target.value.toLowerCase();
                    document.querySelectorAll('#usersTable tbody tr').forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(q) ? '' : 'none';
                    });
                });
            } catch (err) {
                document.getElementById('usersTable').innerHTML = '<p style="color: var(--accent-danger);">Error loading users</p>';
            }
        }

        // Load Vouchers
        async function loadVouchers() {
            try {
                const res = await fetch('/api/admin/vouchers');
                const vouchers = await res.json();

                if (vouchers.length === 0) {
                    document.getElementById('vouchersTable').innerHTML = '<p style="color: var(--text-muted);">No vouchers yet</p>';
                    return;
                }

                let html = `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Discount</th>
                            <th>Description</th>
                            <th>Used</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;

                vouchers.forEach(v => {
                    html += `<tr>
                        <td><strong>${v.code}</strong></td>
                        <td>${v.percent}%</td>
                        <td>${v.description || '-'}</td>
                        <td>${v._count.transactions}x</td>
                        <td>
                            <span class="badge ${v.active ? 'badge-success' : 'badge-danger'}">
                                ${v.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-icon" onclick="toggleVoucher('${v.id}')" title="Toggle Status">
                                <i class="fa-solid fa-power-off"></i>
                            </button>
                            <button class="btn-icon danger" onclick="deleteVoucher('${v.id}')" title="Delete">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                document.getElementById('vouchersTable').innerHTML = html;
            } catch (err) {
                document.getElementById('vouchersTable').innerHTML = '<p style="color: var(--accent-danger);">Error loading vouchers</p>';
            }
        }

        // Create Voucher
        document.getElementById('createVoucherForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('voucherCode').value;
            const percent = document.getElementById('voucherPercent').value;
            const description = document.getElementById('voucherDesc').value;

            try {
                const res = await fetch('/api/admin/vouchers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, percent, description })
                });
                const data = await res.json();

                if (res.ok) {
                    Swal.fire('Success!', 'Voucher created successfully', 'success');
                    document.getElementById('createVoucherForm').reset();
                    loadVouchers();
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            } catch (err) {
                Swal.fire('Error', 'Failed to create voucher', 'error');
            }
        });

        // Toggle Voucher
        async function toggleVoucher(id) {
            try {
                await fetch(`/api/admin/vouchers/${id}`, { method: 'PUT' });
                loadVouchers();
            } catch (err) {
                Swal.fire('Error', 'Failed to update voucher', 'error');
            }
        }

        // Delete Voucher
        async function deleteVoucher(id) {
            const result = await Swal.fire({
                title: 'Delete Voucher?',
                text: 'This action cannot be undone!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Yes, delete!'
            });

            if (result.isConfirmed) {
                try {
                    await fetch(`/api/admin/vouchers/${id}`, { method: 'DELETE' });
                    Swal.fire('Deleted!', 'Voucher has been deleted.', 'success');
                    loadVouchers();
                } catch (err) {
                    Swal.fire('Error', 'Failed to delete voucher', 'error');
                }
            }
        }

        // Load Transactions
        async function loadTransactions() {
            try {
                const res = await fetch('/api/admin/transactions');
                const transactions = await res.json();

                if (transactions.length === 0) {
                    document.getElementById('transactionsTable').innerHTML = '<p style="color: var(--text-muted);">No transactions yet</p>';
                    return;
                }

                let html = `<table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Package</th>
                            <th>Tokens</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>`;

                transactions.forEach(t => {
                    const statusClass = t.status === 'SUCCESS' ? 'badge-success' :
                        t.status === 'PENDING' ? 'badge-warning' : 'badge-danger';
                    html += `<tr>
                        <td style="font-size: 0.75rem; font-family: monospace;">${t.id.substring(0, 15)}...</td>
                        <td>${t.user?.name || 'Unknown'}</td>
                        <td>${t.package}</td>
                        <td>${t.tokens > 0 ? '+' : ''}${t.tokens}</td>
                        <td>Rp ${t.amount.toLocaleString()}</td>
                        <td><span class="badge ${statusClass}">${t.status}</span></td>
                        <td>${new Date(t.createdAt).toLocaleString()}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                document.getElementById('transactionsTable').innerHTML = html;
            } catch (err) {
                document.getElementById('transactionsTable').innerHTML = '<p style="color: var(--accent-danger);">Error loading transactions</p>';
            }
        }

        // Show User Forms Modal
        function showUserForms(userName, forms) {
            const formsHtml = forms.map(form => `
                <div style="padding: 12px; background: var(--bg-input); border-radius: 10px; margin-bottom: 10px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">${form.title}</div>
                    <a href="${form.url}" target="_blank" style="color: var(--primary); font-size: 0.85rem; word-break: break-all;">
                        ${form.url}
                    </a>
                </div>
            `).join('');

            Swal.fire({
                title: `Forms dari ${userName}`,
                html: `
                    <div style="text-align: left; max-height: 400px; overflow-y: auto;">
                        ${formsHtml || '<p style="color: var(--text-muted);">Tidak ada form</p>'}
                    </div>
                `,
                confirmButtonText: 'Tutup',
                confirmButtonColor: '#8b5cf6',
                width: '600px'
            });
        }

        // Add Token to User
        async function addTokenToUser(userId, userName) {
            const { value: formValues } = await Swal.fire({
                title: `Tambah Token ke ${userName}`,
                html: `
                    <div style="text-align: left; margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Jumlah Token</label>
                        <input type="number" id="swal-tokens" class="swal2-input" placeholder="cth: 100" min="1" style="margin: 0; width: 100%;">
                    </div>
                    <div style="text-align: left; margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Alasan (opsional)</label>
                        <input type="text" id="swal-reason" class="swal2-input" placeholder="cth: Bonus reward" style="margin: 0; width: 100%;">
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Tambah Token',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#8b5cf6',
                didOpen: () => {
                    const tokenInput = document.getElementById('swal-tokens');
                    const reasonInput = document.getElementById('swal-reason');
                    tokenInput.focus();

                    const handleEnter = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            Swal.clickConfirm();
                        }
                    };
                    tokenInput.addEventListener('keypress', handleEnter);
                    reasonInput.addEventListener('keypress', handleEnter);
                },
                preConfirm: () => {
                    const tokens = parseInt(document.getElementById('swal-tokens').value);
                    if (!tokens || tokens <= 0) {
                        Swal.showValidationMessage('Masukkan jumlah token yang valid (minimal 1)');
                        return false;
                    }
                    return {
                        tokens: tokens,
                        reason: document.getElementById('swal-reason').value
                    };
                }
            });

            if (formValues) {
                try {
                    const res = await fetch(`/api/admin/users/${userId}/tokens`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formValues)
                    });
                    const data = await res.json();

                    if (res.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil!',
                            text: data.message,
                            confirmButtonColor: '#8b5cf6'
                        });
                        loadUsers(); // Refresh table
                        loadLogs(); // Refresh logs
                    } else {
                        Swal.fire('Error', data.error, 'error');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Gagal menambah token', 'error');
                }
            }
        }

        // Delete Token from User
        async function deleteTokenFromUser(userId, userName, maxBalance) {
            if (maxBalance <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Tidak Ada Token',
                    text: `${userName} tidak memiliki token untuk dihapus.`,
                    confirmButtonColor: '#8b5cf6'
                });
                return;
            }

            const { value: formValues } = await Swal.fire({
                title: `Hapus Token dari ${userName}`,
                html: `
                    <div style="text-align: left; margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Jumlah Token (maks: ${maxBalance})</label>
                        <input type="number" id="swal-tokens" class="swal2-input" placeholder="cth: 50" min="1" max="${maxBalance}" style="margin: 0; width: 100%;">
                    </div>
                    <div style="text-align: left; margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Alasan (opsional)</label>
                        <input type="text" id="swal-reason" class="swal2-input" placeholder="cth: Refund, Penalty" style="margin: 0; width: 100%;">
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Hapus Token',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#ef4444',
                didOpen: () => {
                    const tokenInput = document.getElementById('swal-tokens');
                    const reasonInput = document.getElementById('swal-reason');
                    tokenInput.focus();

                    const handleEnter = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            Swal.clickConfirm();
                        }
                    };
                    tokenInput.addEventListener('keypress', handleEnter);
                    reasonInput.addEventListener('keypress', handleEnter);
                },
                preConfirm: () => {
                    const tokens = parseInt(document.getElementById('swal-tokens').value);
                    if (!tokens || tokens <= 0) {
                        Swal.showValidationMessage('Masukkan jumlah token yang valid');
                        return false;
                    }
                    if (tokens > maxBalance) {
                        Swal.showValidationMessage(`Maksimal ${maxBalance} token`);
                        return false;
                    }
                    return {
                        tokens: -Math.abs(tokens), // Make it negative for deletion
                        reason: document.getElementById('swal-reason').value
                    };
                }
            });

            if (formValues) {
                try {
                    const res = await fetch(`/api/admin/users/${userId}/tokens`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formValues)
                    });
                    const data = await res.json();

                    if (res.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Token Dihapus!',
                            text: data.message,
                            confirmButtonColor: '#8b5cf6'
                        });
                        loadUsers();
                        loadLogs();
                    } else {
                        Swal.fire('Error', data.error, 'error');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Gagal menghapus token', 'error');
                }
            }
        }

        // Load Admin Logs
        async function loadLogs() {
            try {
                const res = await fetch('/api/admin/logs');
                const logs = await res.json();

                if (logs.length === 0) {
                    document.getElementById('logsTable').innerHTML = '<p style="color: var(--text-muted);">No admin actions yet</p>';
                    return;
                }

                let html = `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>Reason</th>
                            <th>Admin</th>
                        </tr>
                    </thead>
                    <tbody>`;

                logs.forEach(log => {
                    const actionClass = log.action.includes('ADD') ? 'badge-success' :
                        log.action.includes('DELETE') ? 'badge-danger' : 'badge-warning';
                    html += `<tr>
                        <td style="font-size: 0.8rem;">${new Date(log.createdAt).toLocaleString()}</td>
                        <td><span class="badge ${actionClass}">${log.action}</span></td>
                        <td style="font-size: 0.85rem;">${log.details}</td>
                        <td style="font-size: 0.85rem;">${log.reason || '-'}</td>
                        <td>${log.adminEmail}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                document.getElementById('logsTable').innerHTML = html;
            } catch (err) {
                document.getElementById('logsTable').innerHTML = '<p style="color: var(--accent-danger);">Error loading logs</p>';
            }
        }

        // Initial Load
        loadUsers();
        loadVouchers();
        loadTransactions();
        loadLogs();
    </script>
</body>

</html>